# Custom ModSecurity Rules to Fix Failed Tests
# These rules target specific attack patterns not covered by OWASP CRS

# Rule 6: Block SQL Server procedure calls (sp_cmdshell, xp_cmdshell)
SecRule ARGS "@rx (?i)(sp_cmdshell|xp_cmdshell|exec\s+sp_)" \
    "id:9006,phase:2,deny,status:403,msg:'SQL Server Procedure Injection - dangerous stored procedure',logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-sqli',tag:'platform-mssql',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 7: Block OS command injection keywords
SecRule ARGS "@rx (?i)(ping|wget|curl|nc|netcat|telnet|ssh|ftp)\s" \
    "id:9007,phase:2,deny,status:403,msg:'OS Command Injection - network command detected',logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-rce',tag:'platform-unix',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 2: Block Ruby sleep injection in cookies
SecRule REQUEST_COOKIES "@rx (?i)(\+|%2b)sleep" \
    "id:9002,phase:1,deny,status:403,msg:'Ruby Code Injection - sleep function in cookie',logdata:'Cookie value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-injection-php',tag:'platform-ruby',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 3: Block Python exec() function calls
SecRule ARGS "@rx (?i)exec\s*\(.*" \
    "id:9003,phase:2,deny,status:403,msg:'Python Code Injection - exec function call',logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-injection-php',tag:'platform-python',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 4: Block Python import statements
SecRule ARGS "@rx (?i)import\s+\w+" \
    "id:9004,phase:2,deny,status:403,msg:'Python Code Injection - import statement',logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-injection-php',tag:'platform-python',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 5: Block Python dangerous built-in functions
SecRule ARGS "@rx (?i)(globals|locals|vars|dir|eval|compile|__import__|getattr|setattr|delattr)\s*\(" \
    "id:9005,phase:2,deny,status:403,msg:'Python Code Injection - dangerous built-in function',logdata:'Parameter: %{MATCHED_VAR_NAME}, Value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-injection-php',tag:'platform-python',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 8: Block SQL injection and command injection in OJSSID cookie
SecRule REQUEST_COOKIES:OJSSID "@rx [\'\"\`\|]" \
    "id:9008,phase:1,deny,status:403,msg:'Code Injection in OJSSID Cookie - dangerous characters detected',logdata:'Cookie value: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-sqli',tag:'attack-rce',tag:'platform-generic',tag:'OWASP_CRS',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 9: Block multiple Content-Length headers (HTTP Request Smuggling)
SecRule &REQUEST_HEADERS:Content-Length "@gt 1" \
    "id:9009,phase:1,deny,status:403,msg:'HTTP Request Smuggling - Multiple Content-Length headers',logdata:'Content-Length headers count: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-protocol',tag:'OWASP_CRS',tag:'capec/1000/210/272/220/33',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 10: Block conflicting Content-Length and Transfer-Encoding headers (CL.TE smuggling)
SecRule REQUEST_HEADERS:Content-Length "@rx ." \
    "id:9010,phase:1,chain,deny,status:403,msg:'HTTP Request Smuggling - CL.TE attack detected (conflicting Content-Length and Transfer-Encoding)',logdata:'Content-Length: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-protocol',tag:'OWASP_CRS',tag:'capec/1000/210/272/220/33',ctl:auditLogParts=+E,ver:'1.0.0'"
SecRule REQUEST_HEADERS:Transfer-Encoding "@rx ."

# Rule 11: Block chunked encoding with specific hex patterns (advanced CL.TE detection)
SecRule REQUEST_BODY "@rx (?i)^[0-9a-f]+\r?\n.*\r?\n0\r?\n" \
    "id:9011,phase:2,deny,status:403,msg:'HTTP Request Smuggling - Chunked encoding pattern detected',logdata:'Request body contains chunked pattern',severity:CRITICAL,tag:'attack-protocol',tag:'OWASP_CRS',tag:'capec/1000/210/272/220/33',ctl:auditLogParts=+E,ver:'1.0.0'"

# Rule 1: Block Transfer-Encoding chunked with request body (HTTP Request Smuggling)
SecRule REQUEST_HEADERS:Transfer-Encoding "@contains chunked" \
    "id:9001,phase:1,deny,status:403,msg:'HTTP Request Smuggling - Transfer-Encoding chunked with body',logdata:'Transfer-Encoding: %{MATCHED_VAR}',severity:CRITICAL,tag:'attack-protocol',tag:'OWASP_CRS',tag:'capec/1000/210/272/220/33',ctl:auditLogParts=+E,ver:'1.0.0'"
