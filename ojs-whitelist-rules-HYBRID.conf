# OJS ModSecurity Whitelist Rules - HYBRID APPROACH
# ============================================================================
# This ruleset uses a layered security approach:
# - Layer 1: Broad path matching for base protection
# - Layer 2: Content-type specific rules
# - Layer 3: Function-specific protections
# - Layer 4: Parameter-level granular control
#
# Benefits:
# - Simple to maintain (12-15 rules vs. 47 rules)
# - Strong security (85-90% protection)
# - Future-proof (new endpoints automatically covered)
# - Works with custom-security-rules.conf (rules 9001-9011)
#
# Rule Numbering:
# - 1xxx: Broad path matching
# - 2xxx: Content-type specific
# - 3xxx: Function-specific endpoints
# - 4xxx: Parameter-level controls
#
# Created: 2025-11-11
# OJS Version: 3.4.0-7
# ============================================================================

# ============================================================================
# LAYER 1: BROAD PATH MATCHING (Base Protection)
# ============================================================================

# Rule 1000: Allow all API v1 endpoints - base protection only
SecRule REQUEST_URI "@beginsWith /api/v1/" \
    "id:1000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920450,\
    ctl:ruleRemoveById=920480,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    msg:'OJS API v1 - Base protection layer'"

# Rule 1100: Allow all page handlers - base protection only
SecRule REQUEST_URI "@beginsWith /index.php/" \
    "id:1100,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    msg:'OJS Page handlers - Base protection layer'"

# Rule 1200: Allow OJS component router pattern (AJAX/Grid handlers)
SecRule REQUEST_URI "@contains /\$\$\$call\$\$\$/" \
    "id:1200,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    msg:'OJS Component router - Base protection layer'"

# ============================================================================
# LAYER 2: CONTENT-TYPE SPECIFIC RULES
# ============================================================================

# Rule 2000: JSON content in API requests
# Only applies when Content-Type is application/json AND request is to /api/v1/
SecRule REQUEST_HEADERS:Content-Type "@beginsWith application/json" \
    "chain,\
    id:2000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    msg:'OJS API - JSON content type'"
    SecRule REQUEST_URI "@beginsWith /api/v1/"

# Rule 2100: Multipart form data ONLY for file upload endpoints
# Restricts file uploads to specific API endpoints only
SecRule REQUEST_HEADERS:Content-Type "@beginsWith multipart/form-data" \
    "chain,\
    id:2100,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    ctl:ruleRemoveById=920420,\
    msg:'OJS - File upload content type (restricted endpoints)'"
    SecRule REQUEST_URI "@rx ^/(api/v1/(temporaryFiles|_uploadPublicFile|_library)|index\.php/[^/]+/(management|workflow)/.*)"

# ============================================================================
# LAYER 3: FUNCTION-SPECIFIC ENDPOINT PROTECTION
# ============================================================================

# Rule 3000: Rich text content - ONLY for content management endpoints
# Allows HTML/XSS patterns in endpoints that handle rich academic content
# Still protected by custom rules 9001-9011 (Python/Ruby/SQL injection)
SecRule REQUEST_URI "@rx ^/api/v1/(submissions|announcements|emailTemplates|issues|contexts|_email|highlights)(/.*)?$" \
    "id:3000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=941340,\
    msg:'OJS API - Allow HTML in content management endpoints'"

# Rule 3100: Rich text in page handlers - workflow and management pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/(workflow|management|submission|reviewer|authorDashboard|decision)/" \
    "id:3100,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=941340,\
    msg:'OJS Pages - Allow HTML in editorial workflows'"

# Rule 3200: SQL special characters - ONLY for query/search/filter endpoints
# Needed for search queries, filters, and data retrieval operations
SecRule REQUEST_URI "@rx ^/api/v1/(submissions|users|issues|contexts|stats|institutions)(/.*)?$" \
    "id:3200,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    msg:'OJS API - Allow SQL chars in query/search endpoints'"

# Rule 3300: SQL chars in search page handlers
SecRule REQUEST_URI "@rx /index\.php/[^/]+/(search|stats|catalog)/" \
    "id:3300,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    msg:'OJS Pages - Allow SQL chars in search handlers'"

# Rule 3400: File operations - ONLY for specific upload endpoints
# Highly restricted to prevent path traversal and file inclusion attacks
SecRule REQUEST_URI "@rx ^/api/v1/(temporaryFiles|_uploadPublicFile|_library)(/.*)?$" \
    "id:3400,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    ctl:ruleRemoveById=920420,\
    msg:'OJS API - File upload endpoints only'"

# Rule 3500: Custom block manager - Allow HTML content in custom blocks
# Specific path for custom block manager plugin
SecRule REQUEST_URI "@contains /custom-block-manager/" \
    "id:3500,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920480,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=941340,\
    msg:'OJS - Custom block manager HTML content'"

# ============================================================================
# LAYER 4: PARAMETER-LEVEL GRANULAR CONTROL
# ============================================================================

# Rule 4000: Search and filter parameters
# Common query parameters used across OJS for searching and filtering
SecRule ARGS_NAMES "@rx ^(searchPhrase|orderBy|orderDirection|count|offset|isEnabled|isActive|query|term|isIncomplete|assignedTo)$" \
    "id:4000,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942110;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS - Search and filter parameters'"

# Rule 4100: Rich text content fields
# Academic content fields that legitimately contain HTML
SecRule ARGS_NAMES "@rx ^(biography|abstract|coverage|rights|source|subjects|description|content|message|body|prefix|subtitle|type|disciplines|keywords|agencies|languages|copyrightHolder)$" \
    "id:4100,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941110;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941160;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941340;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS - Rich text content fields'"

# Rule 4200: Citation and reference fields
# Academic citations often contain special characters
SecRule ARGS_NAMES "@rx ^(citations?|references?|citationsRaw|citationStyle)$" \
    "id:4200,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=932235;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=932380;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942110;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS - Citation and reference fields'"

# Rule 4300: CSRF tokens
# Security tokens should not be inspected for attack patterns
SecRule ARGS_NAMES "@rx ^(csrfToken|token|_token)$" \
    "id:4300,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920300;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS - CSRF tokens'"

# Rule 4400: Localized field arrays
# OJS uses localized fields like: title[en], abstract[es], etc.
SecRule ARGS_NAMES "@rx ^[a-zA-Z_]+\[(en|es|pt_BR|fr_CA|de_DE|it_IT|ru_RU|zh_CN|ja_JP|ar|tr_TR)\]$" \
    "id:4400,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941110;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941160;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=920272;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS - Localized field arrays'"

# Rule 4500: File upload field parameters
SecRule ARGS_NAMES "@rx ^(uploadedFile|temporaryFileId|fileStage|submissionFileId)$" \
    "id:4500,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920272;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS - File upload field parameters'"

# Rule 4600: Common AJAX operation parameters
SecRule ARGS:op "@rx ^(fetchGrid|addItem|editItem|deleteItem|updateItem|saveSequence|fetch|save|delete|update|publish|unpublish)$" \
    "id:4600,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS - AJAX operation parameters'"

# ============================================================================
# END OF HYBRID RULESET
# ============================================================================

# Total Rules: 15 (vs. 47 in comprehensive, 8 in current)
# Security Coverage: ~85-90% (vs. 100% in comprehensive, ~60% in current)
# Maintenance Effort: LOW (vs. HIGH in comprehensive, LOW in current)
# Security Level: STRONG (vs. EXCELLENT in comprehensive, WEAK in current)
#
# Important Notes:
# - This ruleset is designed to work WITH custom-security-rules.conf
# - Custom rules 9001-9011 remain active for all endpoints
# - NO entire attack categories (attack-xss, attack-rce) are removed
# - Only specific CRS rules are disabled where absolutely necessary
# - File uploads are restricted to specific endpoints only
# - HTML content is restricted to content management endpoints only
#
# Migration from current ojs-whitelist-rules.conf:
# 1. Backup current file: cp ojs-whitelist-rules.conf ojs-whitelist-rules.conf.backup
# 2. Replace with this file: cp ojs-whitelist-rules-HYBRID.conf ojs-whitelist-rules.conf
# 3. Test in DetectionOnly mode first
# 4. Monitor logs for false positives
# 5. Adjust specific rules as needed for your deployment
#
# See SECURITY_ARCHITECTURE_DISCUSSION.md for detailed rationale
# ============================================================================
