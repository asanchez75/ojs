# OJS (Open Journal Systems) Comprehensive Whitelist Exception Rules
# Generated based on OJS 3.4.0-7 source code analysis
# These rules allow legitimate OJS functionality while maintaining security

# ============================================================================
# SECTION 1: API v1 Endpoints
# ============================================================================

# Rule 1001: Allow all API v1 endpoints (General)
SecRule REQUEST_URI "@beginsWith /api/v1/" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920450,\
    ctl:ruleRemoveById=920480,\
    msg:'OJS API v1 endpoint whitelist'"

# Rule 1002: Allow JSON content in API requests
SecRule REQUEST_HEADERS:Content-Type "@beginsWith application/json" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    msg:'OJS JSON content whitelist'"

# Rule 1003: Allow Submissions API (GET/POST/PUT/DELETE)
SecRule REQUEST_URI "@rx ^/api/v1/submissions(/\d+)?(/publications(/\d+)?)?(/files)?" \
    "id:1003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=941340,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Submissions API whitelist'"

# Rule 1004: Allow Backend Submissions API
SecRule REQUEST_URI "@beginsWith /api/v1/_submissions" \
    "id:1004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Backend Submissions API whitelist'"

# Rule 1005: Allow Issues API
SecRule REQUEST_URI "@rx ^/api/v1/issues(/\d+|/current)?" \
    "id:1005,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Issues API whitelist'"

# Rule 1006: Allow Users API
SecRule REQUEST_URI "@rx ^/api/v1/users(/\d+)?" \
    "id:1006,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Users API whitelist'"

# Rule 1007: Allow Contexts API
SecRule REQUEST_URI "@rx ^/api/v1/contexts(/\d+)?" \
    "id:1007,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Contexts API whitelist'"

# Rule 1008: Allow Announcements API
SecRule REQUEST_URI "@rx ^/api/v1/announcements(/\d+)?" \
    "id:1008,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Announcements API whitelist'"

# Rule 1009: Allow DOIs API
SecRule REQUEST_URI "@rx ^/api/v1/(_)?dois(/\d+)?" \
    "id:1009,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    msg:'OJS DOIs API whitelist'"

# Rule 1010: Allow Statistics API
SecRule REQUEST_URI "@rx ^/api/v1/stats/(editorial|publications|issues|sushi)" \
    "id:1010,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Statistics API whitelist'"

# Rule 1011: Allow Email Templates API
SecRule REQUEST_URI "@rx ^/api/v1/emailTemplates(/\d+)?" \
    "id:1011,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=941340,\
    msg:'OJS Email Templates API whitelist'"

# Rule 1012: Allow Mailables API
SecRule REQUEST_URI "@beginsWith /api/v1/mailables" \
    "id:1012,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Mailables API whitelist'"

# Rule 1013: Allow Temporary Files API (File uploads)
SecRule REQUEST_URI "@beginsWith /api/v1/temporaryFiles" \
    "id:1013,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    ctl:ruleRemoveById=920420,\
    msg:'OJS Temporary Files API whitelist'"

# Rule 1014: Allow Library Files API
SecRule REQUEST_URI "@beginsWith /api/v1/_library" \
    "id:1014,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    msg:'OJS Library Files API whitelist'"

# Rule 1015: Allow Site API
SecRule REQUEST_URI "@beginsWith /api/v1/site" \
    "id:1015,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Site API whitelist'"

# Rule 1016: Allow Vocabs API
SecRule REQUEST_URI "@beginsWith /api/v1/vocabs" \
    "id:1016,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Vocabs API whitelist'"

# Rule 1017: Allow Highlights API
SecRule REQUEST_URI "@rx ^/api/v1/highlights(/\d+)?" \
    "id:1017,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Highlights API whitelist'"

# Rule 1018: Allow Institutions API
SecRule REQUEST_URI "@rx ^/api/v1/institutions(/\d+)?" \
    "id:1018,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=941100,\
    msg:'OJS Institutions API whitelist'"

# Rule 1019: Allow Jobs API
SecRule REQUEST_URI "@beginsWith /api/v1/jobs" \
    "id:1019,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Jobs API whitelist'"

# Rule 1020: Allow Backend Email API
SecRule REQUEST_URI "@beginsWith /api/v1/_email" \
    "id:1020,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    msg:'OJS Backend Email API whitelist'"

# Rule 1021: Allow Backend Payments API
SecRule REQUEST_URI "@beginsWith /api/v1/_payments" \
    "id:1021,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Backend Payments API whitelist'"

# Rule 1022: Allow Upload Public File API
SecRule REQUEST_URI "@beginsWith /api/v1/_uploadPublicFile" \
    "id:1022,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    ctl:ruleRemoveById=920420,\
    msg:'OJS Upload Public File API whitelist'"

# ============================================================================
# SECTION 2: Page Handlers (index.php/[context]/page/operation)
# ============================================================================

# Rule 2001: Allow Workflow pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/workflow/" \
    "id:2001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Workflow pages whitelist'"

# Rule 2002: Allow Submission pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/submission/" \
    "id:2002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Submission pages whitelist'"

# Rule 2003: Allow Author Dashboard
SecRule REQUEST_URI "@rx /index\.php/[^/]+/authorDashboard/" \
    "id:2003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Author Dashboard whitelist'"

# Rule 2004: Allow Reviewer pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/reviewer/" \
    "id:2004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Reviewer pages whitelist'"

# Rule 2005: Allow Management pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/management/" \
    "id:2005,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=941110,\
    ctl:ruleRemoveById=941160,\
    ctl:ruleRemoveById=941340,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Management pages whitelist'"

# Rule 2006: Allow Issue Management
SecRule REQUEST_URI "@rx /index\.php/[^/]+/manageIssues/" \
    "id:2006,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Issue Management whitelist'"

# Rule 2007: Allow Article pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/article/" \
    "id:2007,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Article pages whitelist'"

# Rule 2008: Allow Issue pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/issue/" \
    "id:2008,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Issue pages whitelist'"

# Rule 2009: Allow User pages (register, login, profile)
SecRule REQUEST_URI "@rx /index\.php/[^/]+/user/" \
    "id:2009,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS User pages whitelist'"

# Rule 2010: Allow Search pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/search/" \
    "id:2010,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Search pages whitelist'"

# Rule 2011: Allow Payment pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/payments?/" \
    "id:2011,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Payment pages whitelist'"

# Rule 2012: Allow Stats pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/stats/" \
    "id:2012,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Stats pages whitelist'"

# Rule 2013: Allow Information pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/information/" \
    "id:2013,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Information pages whitelist'"

# Rule 2014: Allow DOI pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/dois/" \
    "id:2014,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS DOI pages whitelist'"

# Rule 2015: Allow OAI-PMH endpoint
SecRule REQUEST_URI "@rx /index\.php/[^/]+/oai" \
    "id:2015,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    msg:'OJS OAI-PMH endpoint whitelist'"

# Rule 2016: Allow Gateway (plugin) pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/gateway/" \
    "id:2016,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Gateway pages whitelist'"

# Rule 2017: Allow Sitemap
SecRule REQUEST_URI "@rx /index\.php/[^/]+/sitemap/" \
    "id:2017,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Sitemap whitelist'"

# Rule 2018: Allow Decision pages
SecRule REQUEST_URI "@rx /index\.php/[^/]+/decision/" \
    "id:2018,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Decision pages whitelist'"

# ============================================================================
# SECTION 3: Component Router (AJAX/Grid Handlers)
# ============================================================================

# Rule 3001: Allow Component Router call pattern
SecRule REQUEST_URI "@contains /\$\$\$call\$\$\$/" \
    "id:3001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=920440,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Component Router call pattern whitelist'"

# Rule 3002: Allow Grid component requests
SecRule ARGS:component "@rx ^grid\." \
    "id:3002,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=941100,\
    ctl:ruleRemoveById=942100,\
    msg:'OJS Grid component whitelist'"

# Rule 3003: Allow Modal component requests
SecRule ARGS:component "@rx ^modals\." \
    "id:3003,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=941100,\
    msg:'OJS Modal component whitelist'"

# Rule 3004: Allow Tab component requests
SecRule ARGS:component "@rx ^tab\." \
    "id:3004,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Tab component whitelist'"

# Rule 3005: Allow API file component requests
SecRule ARGS:component "@rx ^api\.file\." \
    "id:3005,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    msg:'OJS API file component whitelist'"

# ============================================================================
# SECTION 4: Plugin-Specific Routes
# ============================================================================

# Rule 4001: Citation Style Language Plugin
SecRule REQUEST_URI "@rx /index\.php/[^/]+/citationStyleLanguage/" \
    "id:4001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS Citation Style Language plugin whitelist'"

# Rule 4002: Static Pages Plugin
SecRule REQUEST_URI "@rx /index\.php/[^/]+/(staticPages|%5E)" \
    "id:4002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    ctl:ruleRemoveById=941100,\
    msg:'OJS Static Pages plugin whitelist'"

# Rule 4003: ORCID Profile Plugin
SecRule REQUEST_URI "@rx /index\.php/[^/]+/orcidapi/" \
    "id:4003,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS ORCID Profile plugin whitelist'"

# Rule 4004: JATS Template Plugin
SecRule REQUEST_URI "@rx /index\.php/[^/]+/jatsTemplate/" \
    "id:4004,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS JATS Template plugin whitelist'"

# ============================================================================
# SECTION 5: Common Parameters and Fields
# ============================================================================

# Rule 5001: Allow OJS search parameters with special characters
SecRule ARGS_NAMES "@rx ^(searchPhrase|orderBy|orderDirection|count|offset|isEnabled|isActive|query|term)$" \
    "id:5001,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942110;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS search parameter whitelist'"

# Rule 5002: Allow rich text content in specific OJS fields
SecRule ARGS_NAMES "@rx ^(biography|abstract|coverage|rights|source|subjects|description|content)$" \
    "id:5002,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941110;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941160;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941340;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS rich text content whitelist'"

# Rule 5003: Allow citation formatting
SecRule ARGS_NAMES "@rx ^(citations?|references?|citationsRaw)$" \
    "id:5003,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=932235;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=932380;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942110;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS citation formatting whitelist'"

# Rule 5004: Allow CSRF tokens
SecRule ARGS_NAMES "@rx ^(csrfToken|token|_token)$" \
    "id:5004,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920300;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS CSRF token whitelist'"

# Rule 5005: Allow HTML content in custom block manager
SecRule REQUEST_URI "@contains /custom-block-manager/" \
    "id:5005,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920480,\
    ctl:ruleRemoveTargetById=941160;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941160;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941160;ARGS:blockContent[pt_BR],\
    ctl:ruleRemoveTargetById=941110;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941110;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941110;ARGS:blockContent[pt_BR],\
    ctl:ruleRemoveTargetById=941100;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941100;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941100;ARGS:blockContent[pt_BR],\
    ctl:ruleRemoveTargetById=941340;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941340;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941340;ARGS:blockContent[pt_BR],\
    msg:'OJS custom block manager HTML content whitelist'"

# Rule 5006: Allow localized field arrays
SecRule ARGS_NAMES "@rx ^[a-zA-Z]+\[(en|es|pt_BR|fr_CA)\]$" \
    "id:5006,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941110;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941160;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS localized field arrays whitelist'"

# Rule 5007: Allow file upload fields
SecRule ARGS_NAMES "@rx ^(uploadedFile|temporaryFileId|fileStage)$" \
    "id:5007,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920272;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS file upload fields whitelist'"

# ============================================================================
# SECTION 6: Common Operations
# ============================================================================

# Rule 6001: Allow common AJAX operations
SecRule ARGS:op "@rx ^(fetchGrid|addItem|editItem|deleteItem|updateItem|saveSequence|fetch|save|delete|update)$" \
    "id:6001,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920272,\
    msg:'OJS AJAX operations whitelist'"

# ============================================================================
# NOTES:
# - Rules are numbered by section (1xxx=API, 2xxx=Pages, 3xxx=Components, etc.)
# - Some rules may overlap for defense in depth
# - Monitor logs to fine-tune rules based on actual usage
# - Consider more restrictive rules for production environments
# - Test thoroughly before deploying to production
# ============================================================================
