# OJS (Open Journal Systems) Whitelist Exception Rules
# These rules allow legitimate OJS functionality while maintaining security

# Rule 1: Allow OJS API endpoints (remove problematic rules entirely)
SecRule REQUEST_URI "@contains /api/v1/" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920450,\
    ctl:ruleRemoveById=920480,\
    msg:'OJS API endpoint whitelist'"

# Rule 2: Allow JSON content in API requests
SecRule REQUEST_HEADERS:Content-Type "@beginsWith application/json" \
    "id:8002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=200002,\
    ctl:ruleRemoveById=200003,\
    msg:'OJS JSON content whitelist'"

# Rule 3: Allow OJS search parameters with special characters
SecRule ARGS_NAMES "@rx ^(searchPhrase|orderBy|orderDirection|count|offset|isEnabled|isActive)$" \
    "id:8003,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942100;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS search parameter whitelist'"

# Rule 4: Allow rich text content in specific OJS fields
SecRule ARGS_NAMES "@rx ^(biography|abstract|coverage|rights|source|subjects)$" \
    "id:8004,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=941100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941110;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941160;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=941340;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS rich text content whitelist'"

# Rule 5: Allow citation formatting
SecRule ARGS_NAMES "@rx ^(citations?|references?|citationsRaw)$" \
    "id:8005,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=932235;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=932380;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942100;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=942110;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS citation formatting whitelist'"

# Rule 6: Allow CSRF tokens
SecRule ARGS_NAMES "@rx ^(csrfToken|token|_token)$" \
    "id:8006,\
    phase:2,\
    pass,\
    nolog,\
    ctl:ruleRemoveTargetById=920300;ARGS:%{MATCHED_VAR_NAME},\
    ctl:ruleRemoveTargetById=920440;ARGS:%{MATCHED_VAR_NAME},\
    msg:'OJS CSRF token whitelist'"

# Rule 7: Allow HTML content in custom block manager
SecRule REQUEST_URI "@contains /custom-block-manager/" \
    "id:8007,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=920480,\
    ctl:ruleRemoveTargetById=941160;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941160;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941160;ARGS:blockContent[pt_BR],\
    ctl:ruleRemoveTargetById=941110;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941110;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941110;ARGS:blockContent[pt_BR],\
    ctl:ruleRemoveTargetById=941100;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941100;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941100;ARGS:blockContent[pt_BR],\
    ctl:ruleRemoveTargetById=941340;ARGS:blockContent[en],\
    ctl:ruleRemoveTargetById=941340;ARGS:blockContent[es],\
    ctl:ruleRemoveTargetById=941340;ARGS:blockContent[pt_BR],\
    msg:'OJS custom block manager HTML content whitelist'"

# Rule 8: Allow submissions/publications API - relax security for academic content
SecRule REQUEST_URI "@rx /api/v1/submissions/\d+/publications/\d" \
    "id:8008,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=9007,\
    ctl:ruleRemoveById=9004,\
    ctl:ruleRemoveByTag=attack-rce,\
    ctl:ruleRemoveByTag=attack-xss,\
    msg:'OJS submissions/publications API - allow academic content'"
